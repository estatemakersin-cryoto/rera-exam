generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  email                String?            @unique
  createdAt            DateTime           @default(now())
  fullName             String
  isAdmin              Boolean            @default(false)
  mobile               String?            @unique
  passwordHash         String?
  testsRemaining       Int                @default(0)
  packageExpiry        DateTime?
  packagePurchased     Boolean            @default(false)
  packagePurchasedDate DateTime?
  referralCode         String?            @unique
  referralCount        Int                @default(0)
  referredBy           String?
  testsCompleted       Int                @default(0)
  testsUnlocked        Int                @default(0)
  avatar               String?
  isActive             Boolean            @default(true)
  isVerified           Boolean            @default(false)
  lastLoginAt          DateTime?
  role                 UserRole           @default(CANDIDATE)
  updatedAt            DateTime           @default(now()) @updatedAt
  certificates         Certificate[]
  examPayments         ExamPayment[]
  instituteStaffRoles  InstituteStaff[]
  instituteEnrollments InstituteStudent[]
  paymentProofs        PaymentProof[]
  referralAsConverted  Referral[]         @relation("ReferralConvertedUser")
  referralsMade        Referral[]         @relation("UserReferrals")
  attempts             TestAttempt[]
  applications         ExamApplication[]
}

model SystemConfig {
  id          String         @id @default(cuid())
  key         String         @unique
  value       String
  label       String
  description String?
  category    String         @default("GENERAL")
  dataType    ConfigDataType @default(STRING)
  isEditable  Boolean        @default(true)
  isPublic    Boolean        @default(false)
  updatedAt   DateTime       @updatedAt
}

model Referral {
  id              Int            @id @default(autoincrement())
  referrerId      String
  name            String?
  mobile          String
  status          ReferralStatus @default(PENDING)
  convertedUserId String?
  createdAt       DateTime       @default(now())
  rewardAmount    Int?
  rewardGiven     Boolean        @default(false)
  rewardGivenAt   DateTime?
  source          String?
  updatedAt       DateTime       @default(now()) @updatedAt
  convertedUser   User?          @relation("ReferralConvertedUser", fields: [convertedUserId], references: [id])
  referrer        User           @relation("UserReferrals", fields: [referrerId], references: [id])
}

model Chapter {
  id                   Int               @id @default(autoincrement())
  chapterNumber        Int               @unique
  titleEn              String
  titleMr              String?
  isActive             Boolean           @default(true)
  actChapterNameEn     String?
  actChapterNameMr     String?
  descriptionEn        String?
  descriptionMr        String?
  displayInApp         Boolean           @default(true)
  mahareraEquivalentEn String?
  mahareraEquivalentMr String?
  orderIndex           Int?
  sections             String?
  questions            Question[]
  revision             RevisionContent[]
}

model RevisionContent {
  id        Int      @id @default(autoincrement())
  chapterId Int
  contentEn String?
  contentMr String?
  imageUrl  String?
  qaJson    Json?    @default("[]")
  createdAt DateTime @default(now())
  order     Int      @default(0)
  titleEn   String
  titleMr   String
  updatedAt DateTime @updatedAt
  videoUrl  String?
  chapter   Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
}

model Question {
  questionMr    String?
  correctAnswer String
  difficulty    Difficulty @default(MODERATE)
  chapterId     Int
  questionEn    String
  id            Int        @id @default(autoincrement())
  optionAEn     String
  optionAMr     String?
  optionBEn     String
  optionBMr     String?
  optionCEn     String
  optionCMr     String?
  optionDEn     String
  optionDMr     String?
  createdAt     DateTime   @default(now())
  instituteId   String?
  isActive      Boolean    @default(true)
  updatedAt     DateTime   @default(now()) @updatedAt
  chapter       Chapter    @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  institute     Institute? @relation(fields: [instituteId], references: [id])
  responses     Response[]

  @@index([chapterId])
  @@index([instituteId])
}

model TestAttempt {
  id              String       @id @default(cuid())
  userId          String?
  application     ExamApplication[]
  startTime       DateTime     @default(now())
  endTime         DateTime?
  score           Int?
  totalQuestions  Int          @default(50)
  correctAnswers  Int?
  status          TestStatus   @default(IN_PROGRESS)
  durationMinutes Int          @default(60)
  examSessionId   String?
  isPassed        Boolean?
  mode            TestMode     @default(PRACTICE)
  passingMarks    Int?
  certificate     Certificate?
  responses       Response[]
  examSession     ExamSession? @relation(fields: [examSessionId], references: [id])
  user            User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([examSessionId])
}

model Response {
  id              String      @id @default(cuid())
  attemptId       String
  userAnswer      String?
  isCorrect       Boolean?
  createdAt       DateTime    @default(now())
  questionId      Int
  markedForReview Boolean     @default(false)
  attempt         TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question        Question    @relation(fields: [questionId], references: [id])

  @@index([attemptId])
  @@index([questionId])
}

model PaymentProof {
  id            String        @id @default(cuid())
  userId        String
  amount        Int
  createdAt     DateTime      @default(now())
  notes         String?
  planType      String
  transactionId String
  status        PaymentStatus @default(PENDING)
  updatedAt     DateTime      @default(now()) @updatedAt
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model ExamPayment {
  id             String        @id @default(cuid())
  userId         String
  amount         Int
  planType       String
  status         PaymentStatus @default(PENDING)
  transactionId  String
  notes          String?
  instituteId    String?
  platformShare  Int?
  instituteShare Int?
  approvedAt     DateTime?
  approvedBy     String?
  rejectedAt     DateTime?
  rejectedReason String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  institute      Institute?    @relation(fields: [instituteId], references: [id])
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([instituteId])
}

model Institute {
  id                  String             @id @default(cuid())
  name                String
  code                String             @unique
  description         String?
  contactPerson       String
  contactPhone        String
  contactEmail        String?
  address             String?
  city                String?
  state               String             @default("Maharashtra")
  logo                String?
  primaryColor        String             @default("#1E40AF")
  secondaryColor      String             @default("#3B82F6")
  subdomain           String?            @unique
  isActive            Boolean            @default(false)
  isVerified          Boolean            @default(false)
  verifiedAt          DateTime?
  validUntil          DateTime?
  revenueSharePercent Int                @default(20)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  batches             Batch[]
  certificates        Certificate[]
  payments            ExamPayment[]
  applications        ExamApplication[]
  examSessions        ExamSession[]
  branches            InstituteBranch[]
  staff               InstituteStaff[]
  students            InstituteStudent[]
  questions           Question[]
}

model InstituteBranch {
  id              String             @id @default(cuid())
  instituteId     String
  name            String
  address         String?
  city            String?
  contactPerson   String?
  contactPhone    String?
  isActive        Boolean            @default(true)
  isHeadOffice    Boolean            @default(false)
  isOnline        Boolean            @default(false)
  subscriptionFee Int?
  validUntil      DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  batches         Batch[]
  institute       Institute          @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  students        InstituteStudent[]

  @@index([instituteId])
  @@index([city])
}

model InstituteStaff {
  id                 String             @id @default(cuid())
  instituteId        String
  userId             String
  role               InstituteStaffRole @default(STAFF)
  isActive           Boolean            @default(true)
  canManageStudents  Boolean            @default(true)
  canManageBatches   Boolean            @default(false)
  canManageExams     Boolean            @default(false)
  canManageQuestions Boolean            @default(false)
  canViewReports     Boolean            @default(true)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  institute          Institute          @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  user               User               @relation(fields: [userId], references: [id])

  @@unique([instituteId, userId])
  @@index([instituteId])
  @@index([userId])
}

model InstituteStudent {
  id          String           @id @default(cuid())
  instituteId String
  userId      String
  branchId    String?
  batchId     String?
  status      EnrollmentStatus @default(APPLIED)
  appliedAt   DateTime         @default(now())
  enrolledAt  DateTime?
  completedAt DateTime?
  notes       String?
  batch       Batch?           @relation(fields: [batchId], references: [id])
  branch      InstituteBranch? @relation(fields: [branchId], references: [id])
  institute   Institute        @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id])

  @@unique([instituteId, userId])
  @@index([instituteId])
  @@index([userId])
  @@index([branchId])
  @@index([batchId])
}

model Batch {
  id           String             @id @default(cuid())
  instituteId  String
  branchId     String?
  name         String
  description  String?
  mode         BatchMode          @default(OFFLINE)
  startDate    DateTime
  endDate      DateTime
  startTime    String?
  endTime      String?
  maxStudents  Int                @default(50)
  fee          Int
  address      String?
  city         String?
  meetingLink  String?
  isActive     Boolean            @default(true)
  isPublished  Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  branch       InstituteBranch?   @relation(fields: [branchId], references: [id])
  institute    Institute          @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  examSessions ExamSession[]
  students     InstituteStudent[]

  @@index([instituteId])
  @@index([branchId])
  @@index([isPublished])
  @@index([mode])
}

model ExamSession {
  id                    String        @id @default(cuid())
  instituteId           String
  batchId               String?
  name                  String
  description           String?
  applications          ExamApplication[]
  examDate              DateTime
  startTime             DateTime
  endTime               DateTime
  durationMinutes       Int           @default(60)
  totalQuestions        Int           @default(50)
  passingMarks          Int           @default(20)
  useInstituteQuestions Boolean       @default(false)
  isActive              Boolean       @default(false)
  isCompleted           Boolean       @default(false)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  batch                 Batch?        @relation(fields: [batchId], references: [id])
  institute             Institute     @relation(fields: [instituteId], references: [id], onDelete: Cascade)
  attempts              TestAttempt[]

  @@index([instituteId])
  @@index([batchId])
  @@index([examDate])
}

model Certificate {
  id              String      @id @default(cuid())
  certificateNo   String      @unique
  userId          String
  attemptId       String      @unique
  instituteId     String?
  studentName     String
  score           Int
  totalQuestions  Int
  percentage      Float
  issueDate       DateTime    @default(now())
  expiryDate      DateTime?
  qrCodeUrl       String?
  pdfUrl          String?
  verificationUrl String?
  isRevoked       Boolean     @default(false)
  revokedAt       DateTime?
  revokedReason   String?
  revokedBy       String?
  createdAt       DateTime    @default(now())
  attempt         TestAttempt @relation(fields: [attemptId], references: [id])
  institute       Institute?  @relation(fields: [instituteId], references: [id])
  user            User        @relation(fields: [userId], references: [id])

  @@index([certificateNo])
  @@index([userId])
  @@index([instituteId])
}

model AgentProfile {
  id                 String   @id @default(cuid())
  userId             String   @unique
  reraNumber         String?
  reraCertificateUrl String?
  company            String?
  experience         Int?
  specializations    String[] @default([])
  languages          String[] @default([])
  whatsapp           String?
  website            String?
  totalLeads         Int      @default(0)
  totalDeals         Int      @default(0)
  rating             Float    @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  INSTITUTE_OWNER
  INSTITUTE_STAFF
  AGENT
  CANDIDATE
  BUYER_SELLER
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ReferralStatus {
  PENDING
  SUCCESS
  CONFIRMED
  REWARDED
}

enum TestStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum TestMode {
  PRACTICE
  REAL_EXAM
}

enum Difficulty {
  EASY
  MODERATE
  HARD
}

enum EnrollmentStatus {
  APPLIED
  ENROLLED
  COMPLETED
  DROPPED
  REJECTED
}

enum InstituteStaffRole {
  OWNER
  ADMIN
  STAFF
}

enum ConfigDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

enum BatchMode {
  ONLINE
  OFFLINE
}


// ─────────────────────────────────────────────────────────────────────────────────
// EXAM APPLICATION MODEL
// Stores practice exam application data (mirrors TCS iON form)
// ─────────────────────────────────────────────────────────────────────────────────

model ExamApplication {
  id                  String   @id @default(cuid())
  
  // Application Reference
  applicationNumber   String   @unique  // "EM2025001234"
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 1: PERSONAL DETAILS
  // ═══════════════════════════════════════════════════════════════════════════
  
  candidateName       String?            // As per PAN (uppercase)
  dateOfBirth         DateTime?
  gender              String?            // Male/Female/Other
  fatherName          String?
  motherName          String?
  email               String?
  mobile              String?
  alternateMobile     String?
  
  // Photo Upload
  photoUrl            String?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 2: IDENTITY & EXAM DETAILS
  // ═══════════════════════════════════════════════════════════════════════════
  
  panNumber           String?            // AAAAA9999A format
  nameOnPan           String?
  postApplied         String   @default("REAL ESTATE AGENT EXAM")
  trainingInstitute   String?
  trainingCertNo      String?            // SIMRERA019071
  isPwBD              Boolean  @default(false)
  pwbdType            String?
  pwbdPercentage      Int?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 3: ADDRESS DETAILS
  // ═══════════════════════════════════════════════════════════════════════════
  
  // Correspondence Address
  corrAddressLine1    String?
  corrAddressLine2    String?
  corrCountry         String   @default("India")
  corrState           String?
  corrDistrict        String?
  corrPincode         String?
  
  // Permanent Address
  sameAsCorrespondence Boolean @default(false)
  permAddressLine1    String?
  permAddressLine2    String?
  permCountry         String?
  permState           String?
  permDistrict        String?
  permPincode         String?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 4: EXAM CENTRE PREFERENCES
  // ═══════════════════════════════════════════════════════════════════════════
  
  centrePreference1   String?            // District name
  centrePreference2   String?
  centrePreference3   String?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 5: DOCUMENTS
  // ═══════════════════════════════════════════════════════════════════════════
  
  signatureUrl        String?
  panCardUrl          String?
  trainingCertUrl     String?
  pwbdCertUrl         String?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // STEP 6: DECLARATION
  // ═══════════════════════════════════════════════════════════════════════════
  selfieUrl           String? 
  declarationAccepted Boolean  @default(false)
  declarationDate     DateTime?
  
  // ═══════════════════════════════════════════════════════════════════════════
  // APPLICATION STATUS & TRACKING
  // ═══════════════════════════════════════════════════════════════════════════
  
  status              ApplicationStatus @default(DRAFT)
  currentStep         Int      @default(1)  // 1-6
  
  // For Institute Mode (optional)
  instituteId         String?
  institute           Institute? @relation(fields: [instituteId], references: [id])
  batchId             String?
  
  // Review (for institute mode)
  reviewedAt          DateTime?
  reviewedBy          String?
  rejectionReason     String?
  
  // Exam Assignment
  examSessionId       String?
  examSession         ExamSession? @relation(fields: [examSessionId], references: [id])
  rollNumber          String?      // Generated before exam
  seatNumber          String?
  
  // Admit Card
  admitCardGenerated  Boolean  @default(false)
  admitCardUrl        String?
  
  // Exam & Result
  testAttemptId       String?  @unique
  testAttempt         TestAttempt? @relation(fields: [testAttemptId], references: [id])
  examAttended        Boolean  @default(false)
  examScore           Int?
  resultStatus        String?  // passed, failed
  resultDeclaredAt    DateTime?
  
  // Certificate
  certificateId       String?
  certificateNumber   String?
  certificateUrl      String?
  certificateIssuedAt DateTime?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  submittedAt         DateTime?
  
  // Logs
  logs                ApplicationLog[]
  
  @@index([userId])
  @@index([status])
  @@index([instituteId])
  @@index([examSessionId])
  @@index([applicationNumber])
}

// ─────────────────────────────────────────────────────────────────────────────────
// APPLICATION LOG MODEL
// Tracks all actions on an application
// ─────────────────────────────────────────────────────────────────────────────────

model ApplicationLog {
  id              String   @id @default(cuid())
  applicationId   String
  application     ExamApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  action          String   // created, step_completed, submitted, approved, etc.
  description     String
  previousStatus  String?
  newStatus       String?
  stepNumber      Int?
  
  performedBy     String?  // userId who performed the action
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  @@index([applicationId])
}

// ─────────────────────────────────────────────────────────────────────────────────
// EXAM CENTRE MODEL (for practice - can be skipped in MVP)
// ─────────────────────────────────────────────────────────────────────────────────

model ExamCentre {
  id              String   @id @default(cuid())
  
  centreName      String   // "ABC Institute, Mumbai"
  centreCode      String   @unique  // "MUM001"
  district        String
  address         String
  city            String
  state           String   @default("Maharashtra")
  pincode         String
  
  capacity        Int      @default(100)
  allocatedCount  Int      @default(0)
  
  isActive        Boolean  @default(true)
  
  // Contact
  contactPerson   String?
  contactPhone    String?
  contactEmail    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([district])
  @@index([city])
}

// ─────────────────────────────────────────────────────────────────────────────────
// ENUM: APPLICATION STATUS
// ─────────────────────────────────────────────────────────────────────────────────

enum ApplicationStatus {
  DRAFT                 // Application started but not submitted
  SUBMITTED             // Application submitted, pending review
  PAYMENT_PENDING       // Awaiting payment (if applicable)
  PAYMENT_SUCCESS       // Payment completed
  APPROVED              // Application approved by institute/admin
  REJECTED              // Application rejected
  ADMIT_CARD_ISSUED     // Admit card generated
  APPEARED              // Candidate appeared for exam
  PASSED                // Exam passed
  FAILED                // Exam failed
  CERTIFICATE_ISSUED    // Certificate generated
}

